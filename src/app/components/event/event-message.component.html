<div class="card">
  <div class="header">
    <h2 class="title">Event Messages</h2>
  </div>
</div>
<div class="card" *ngIf="eventMessagesPageable != null">
  <div *ngIf="feedback" class="alert alert-{{feedback.type}}">{{ feedback.message }}</div>
  <div class="table-responsive">

    <ul>
      <li *ngFor="let item of statusCountReport">{{item.status}}: {{item.statusCount}}</li>
    </ul>

    <input type="text" class="form-control" id="txtStatus" placeholder="Search by status" [(ngModel)]="status">
    <input type="text" class="form-control" id="txtKeyword" placeholder="Search by keyword" [(ngModel)]="keyword">

    <button type="button" (click)="search()" class="btn btn-secondary btn-sm">Search</button>&nbsp;
    <button type="button" (click)="clearSearch()" class="btn btn-secondary btn-sm">Clear</button>&nbsp;

    Total: {{eventMessagesPageable.totalElements}} Current:{{eventMessagesPageable.numberOfElements}}

    <form [formGroup]="eventMessageForm" (ngSubmit)="onSubmit()">
      <table class="table table-centered table-hover mb-0 table-sm table-responsive" id="datatable">
        <thead>
          <tr>
            <th class="border-top-0" scope="col">Id</th>
            <th class="border-top-0" scope="col">QueueName</th>
            <th class="border-top-0" scope="col">EventId</th>
            <th class="border-top-0" scope="col">Message</th>
            <th class="border-top-0" scope="col">Size</th>
            <th class="border-top-0" scope="col">Start date</th>
            <th class="border-top-0" scope="col">End date</th>
            <th class="border-top-0" scope="col">Duration</th>
            <th class="border-top-0" scope="col">dequeueCount</th>
            <th class="border-top-0" scope="col">Status</th>
            <th class="border-top-0" scope="col">Description</th>
            <th class="border-top-0" scope="col" style="width:120px"></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              {{f.id.value || 'n/a'}}
            </td>
            <td>
            </td>
            <td>
              <div class="form-group">
                <select formControlName="eventId" class="form-control">
                  <option *ngFor="let event of eventLookup" [ngValue]="event.id">{{event.name}}</option>
                </select>
                <div *ngIf="f.eventId.invalid && (f.eventId.dirty || f.eventId.touched)" class="alert alert-danger">
                  <div *ngIf="f.eventId.errors.required">
                    Event is required.
                  </div>
                </div>
              </div>
            </td>
            <td>
              <div class="form-group">
                <textarea formControlName="message" placeholder="message"></textarea>


                <div *ngIf="f.message.invalid && (f.message.dirty || f.message.touched)" class="alert alert-danger">

                  <div *ngIf="f.message.errors.required">
                    Message is required
                  </div>
                </div>
              </div>
            </td>
            <td>

            </td>
            <td>

            </td>
            <td>

            </td>
            <td>

            </td>
            <td>

            </td>
            <td>

            </td>
            <td>

            </td>
            <td style="white-space: nowrap">

              <button type="submit" class="btn btn-secondary btn-sm" [disabled]="!eventMessageForm.valid">Save</button>&nbsp;
              <button type="button" class="btn btn-secondary btn-sm" (click)="clearForm()">Clear</button>

            </td>
          </tr>

          <tr *ngFor="let item of eventMessagesPageable.content">

            <td>{{item.id}}</td>
            <td>{{item.queueName}}</td>
            <td>{{item.eventName}}</td>
            <td>{{item.message != null ? item.message.substring(0,50)+'...' : null}}</td>
            <td>{{item.size}}</td>
            <td>{{item.startDate}}</td>

            <td>{{item.endDate}}</td>

            <td>{{item.duration}}Âµs</td>
            <td>{{item.dequeueCount}}</td>

            <td>

              <div *ngIf="item.status == 'DONE'; else nonErrorTemplate">
                <span class="badge badge-secondary">{{item.status}}</span>
              </div>

              <ng-template #nonErrorTemplate>
                {{item.status}}
              </ng-template>

            </td>
            <td>{{item.statusDescription}}</td>
            <td style="white-space: nowrap">
              <a *ngIf="item.traceInstanceId" [routerLink]="['/traces/instance', item.traceInstanceId ]"
                class="btn btn-secondary btn-sm">Trace</a>&nbsp;
              <a *ngIf="item.traceInstanceId" [routerLink]="['/eventmessages/', item.id ]"
                class="btn btn-secondary btn-sm">Edit</a>&nbsp;
              <button  [disabled]="item.status == 'QUEUED' " type="button" (click)="delete(item)" class="btn btn-danger btn-sm">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </form>
  </div>
</div>