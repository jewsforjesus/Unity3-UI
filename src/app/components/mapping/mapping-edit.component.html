<h2 class="title">{{formHeader}}</h2>
<div *ngIf="messageTemplateMap != null">
  <div *ngIf="feedback" class="alert alert-{{feedback.type}}">{{ feedback.message }}</div>
  <form [formGroup]="messageTemplateMapForm" (ngSubmit)="onSubmit()">


    {{f.id.value || 'n/a'}}

    <div class="form-group">
      <label class="form-check-label" for="name">Name</label>

      <input id="name" formControlName="name" class="form-control">


      <div *ngIf="f.name.invalid && (f.name.dirty || f.name.touched)" class="alert alert-danger">

        <div *ngIf="f.name.errors.required">
          Name is required.
        </div>
      </div>

    </div>
    <div class="form-group">
      <label class="form-check-label" for="description">Description</label>

      <input id="description" formControlName="description" class="form-control">

    </div>

    <div class="form-group">
      <label class="form-check-label" for="sourceMessageTemplateId">Source Template</label>

      <select formControlName="sourceMessageTemplateId" class="form-control"
        (change)="refreshSourcePathList($event.target.value)">
        <option *ngFor="let template of messageTemplates" [ngValue]="template.id">{{template.name}}</option>
      </select>
      <div
        *ngIf="f.sourceMessageTemplateId.invalid && (f.sourceMessageTemplateId.dirty || f.sourceMessageTemplateId.touched)"
        class="alert alert-danger">
        <div *ngIf="f.sourceMessageTemplateId.errors.required">
          Source message template is required.
        </div>
      </div>
    </div>




    <div class="form-group">
      <label class="form-check-label" for="targetMessageTemplateId">Target Template</label>

      <select id="targetMessageTemplateId" formControlName="targetMessageTemplateId" class="form-control"
        (change)="refreshTargetPathList($event.target.value)">
        <option *ngFor="let template of messageTemplates" [ngValue]="template.id">{{template.name}}</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-check-label" for="clientScript">Client Script</label>
      <textarea id="clientScript" formControlName="clientScript" class="form-control" rows="5"></textarea>
    </div>


    <div class="form-group">
      <label class="form-check-label" for="transformClassPath">Transform Class</label>
      <select id="transformClassPath" formControlName="transformClassPath" class="form-control">
        <option *ngFor="let item of transformClassLookup" [ngValue]="item.key">{{item.value}}</option>
      </select>
    </div>

    <div class="form-group">

      <div class="row g-3">
        <div class="col">

          <label class="form-check-label" for="joinKeySource">Source join key</label>

          <select id="joinKeySource" formControlName="joinKeySource" class="form-control">
            <option *ngFor="let path of sourcePath" [ngValue]="path">{{path}}</option>
          </select>


        </div>
        <div class="col">

          <label class="form-check-label" for="joinKeyTarget">Target join key</label>

          <select id="joinKeyTarget" formControlName="joinKeyTarget" class="form-control">
            <option *ngFor="let path of targetPath" [ngValue]="path">{{path}}</option>
          </select>

        </div>
      </div>


    </div>




    <div *ngIf="sourcePath && targetPath && messageTemplateMap" formArrayName="mappings">
      <table class="table table-striped table-sm">

        <tbody>
          <tr *ngFor="let mapping of mappings().controls; let mappingIndex=index">

            <td>
              <div [formGroupName]="mappingIndex">

            <td>
              <div formArrayName="sources">


                <div *ngFor="let source of mappingSources(mappingIndex).controls; let sourceIndex=index">

                  <div [formGroupName]="sourceIndex" class="form-inline">

                    <select formControlName="source" class="form-control">
                      <option *ngFor="let path of sourcePath" [ngValue]="path">{{path}}</option>
                    </select>

                    <button type="button" (click)="removeMappingSource(mappingIndex, sourceIndex)"
                      class="btn btn-danger btn-sm">Remove Source</button>

                  </div>

                </div>

              </div>


              <button type="button" (click)="addMappingSource(mappingIndex)" class="btn btn-secondary btn-sm">Add
                Source</button>

            </td>

            <td><input formControlName="client_function" placeholder="client_function" class="form-control"></td>
            <td>

              <select formControlName="function" class="form-control">
                <option *ngFor="let function of transformFunctionLookup" [ngValue]="function.key">{{function.value}}
                </option>
              </select>

            </td>
            <td>

              <select formControlName="target" class="form-control">
                <option *ngFor="let path of targetPath" [ngValue]="path">{{path}}</option>
              </select>

            </td>
            <td>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" formControlName="inactive" title="Inactive?">
              </div>
            </td>


            <td><button type="button" (click)="removeMapping(mappingIndex)" class="btn btn-danger btn-sm">Remove
                Mapping</button></td>


    </div>

    </td>
    </tr>
    </tbody>
    </table>

    <button type="button" (click)="addMapping()" class="btn btn-secondary btn-sm">Add Mapping</button>&nbsp;

</div>

<div>
  <button type="submit" class="btn btn-secondary btn-sm" [disabled]="!messageTemplateMapForm.valid">Save</button>&nbsp;
  <button type="button" class="btn btn-secondary btn-sm" (click)="cancel()">Cancel</button>
</div>
</form>

</div>